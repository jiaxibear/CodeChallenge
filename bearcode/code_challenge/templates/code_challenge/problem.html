{% extends "code_challenge/base.html" %}

{% block title %}Problem{% endblock %}

{% block mainbody %}

<script src="/static/ace-builds/src-noconflict/ace.js" type="text/javascript"
        charset="utf-8"></script>
<script src="/static/js/jquery-2.1.4.min.js" type="text/javascript"></script>
<script src="/static/ace-builds/src-noconflict/theme-github.js" type="text/javascript"
        charset="utf-8"></script>

<style type="text/css" media="screen">
    textarea {
        display: block;
        margin: auto;
        width: 600px;
        height: 5px;
    }
    #editor_div {
        display: block;
        margin: auto;
        width: 700px;
        height: 400px;
        border: 1px solid #888;
    }
</style>


<div style="text-align:left">
    <h1>{{problem.name}}</h1>
    <hr>
    <p>Description: {{problem.description}}</p>

    <p>{{problem.example}}</p>

    <div id="editor_div">{{problem.default}}</div>
    <br>
    <input type="hidden" id="problemid" value="{{problem.id}}">
    <hr>
    <button id="submitbtn" class="btn btn-success btn-lg">Submit Code</button>
    <div id="status"></div>
    <div id="message"></div>
</div>
<script>
    $(document).ready(function() {
        var textarea = $('textarea[name="editor"]');
        textarea.hide();
        var editor = ace.edit("editor_div");
        editor.setTheme("ace/theme/monokai");
        editor.getSession().setMode("ace/mode/java");
        $('#submitbtn').on('click', function() {
            submitCode(editor.getValue());
        });

        $("#submitbtn").on("click", function(event) {
            console.log("submit once!");
            submitCode();
        });

      // CSRF set-up copied from Django docs
      function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie != '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) == (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
      }
      var csrftoken = getCookie('csrftoken');
      $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
      });
    });

    function submitCode(code_content){
        var problemid = $("#problemid").val();
        var submit_url = "/trysubmit";
        var textarea = $('textarea[name="editor"]');
        textarea.hide();
        var editor = ace.edit("editor_div");

        console.log("url is:"+submit_url+", problem id is:"+problemid);
        console.log("submitted content is:"+code_content);

        $.ajax({
            url : submit_url,
            dataType: "json",
            method: "POST",
            data: {problemid:problemid,codecontent:code_content}
        })
        .done(function(result) {
            console.log("successfully submitted, get result"+result.status);
            var resultstatus = result.status;
            var statusPanel = $("#status")
            var msgPanel = $("#message")
            if(resultstatus=="success"){
                statusPanel.css("color","green");
                statusPanel.text(result.status);
            }
            else{
                statusPanel.css("color","red");
                statusPanel.text(result.status);
                msgPanel.text(result.message);
            }
        });
    }

</script>
{% endblock %}